<!DOCTYPE html>
<html lang="en">
  <head>
    <style>
      .button {
        background-color: gray; /* Green */
        border: none;
        color: black;
        padding: 20px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        margin: 4px 2px;
        cursor: pointer;
      }
      .button1 {border-radius: 8px;}
      </style>
    <meta charset="utf-8" />
    <!-- Latest compiled and minified CSS -->
    <script src="https://code.jquery.com/jquery.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>

    <link
      rel="stylesheet"
      href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />

    <!-- New font -->
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" 
    rel="stylesheet">
    
    <link
      href="//netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css"
      rel="stylesheet"
    />

    <!-- Optional theme -->
    <link
      rel="stylesheet"
      href="//stackpath.bootstrapcdn.com/bootswatch/4.1.1/spacelab/bootstrap.min.css"
    />
    
    <!-- Latest compiled and minified JavaScript -->
    <script
      src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>

    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0">-->
    <script src="//d3js.org/d3.v5.js"></script>
    <script src="../js/phylotree.js"></script>
    <script src="../js/nodescores.js"></script>
    <link href="../css/phylotree.css" rel="stylesheet" />

    <style>
      nav {
        margin-bottom: 25px;
      }

      .fa-rotate-45 {
        -webkit-transform: rotate(45deg);
        -moz-transform: rotate(45deg);
        -ms-transform: rotate(45deg);
        -o-transform: rotate(45deg);
        transform: rotate(45deg);
      }

      .fa-rotate-135 {
        -webkit-transform: rotate(135deg);
        -moz-transform: rotate(135deg);
        -ms-transform: rotate(135deg);
        -o-transform: rotate(135deg);
        transform: rotate(135deg);
      }

      @media (max-width: 1075px) {
        .container {
          padding-top: 50px;
        }
      }

      .button {
        height: 30px;
      }

      #toolbar {
        display: flex;
        justify-content: space-between;
        width: 550px;
      }

      #controls {
        position: fixed;
        left: 5px;
      }
    </style>
  </head>

  <body>
    <!--
###############################################################################################################################
-->

    <nav class="navbar navbar-expand-lg navbar-light bg-light">
      <!-- <a class="navbar-brand" href="#">phylotree.js</a> -->

      <!-- Collect the nav links, forms, and other content for toggling -->
      <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a
              href="#"
              id="newick-dropdown"
              class="nav-link dropdown-toggle"
              role="button"
              data-toggle="dropdown"
              >Files <b class="caret"></b
            ></a>
            <div class="dropdown-menu">
              <a
                class="dropdown-item"
                href="#"
                data-toggle="modal"
                data-target="#newick_modal"
                >Compare file Text</a
              >
              <a class="dropdown-item" href="#"
                ><input type="file" id="newick_file"
              /></a>
              <a class="dropdown-item" href="#"
                ><input type="file" id="newick_file2"
              /></a>
              <div class="dropdown-divider"></div>
              <a
                class="dropdown-item"
                href="#"
                data-toggle="modal"
                data-target="#newick_export_modal"
                >Export</a
              >
            </div>
          </li>
        </ul>

        <ul class="navbar-nav ml-auto">
          <li>
            <form class="form-inline my-2 my-lg-0">
              <input
                type="text"
                id="branch_filter"
                class="form-control"
                placeholder="Search"
              />
            </form>
          </li>
        </ul>
      </div>


      <!-- /.container-fluid -->
    </nav>

    <div class="modal" id="newick_modal" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title">Newick string to render</h4>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-hidden="true"
            >
              &times;
            </button>
          </div>
          <div class="modal-body" id="newick_body">
            <textarea
              id="nwk_spec"
              autofocus="true"
              placeholder=""
              style="width: 100%; height: 100%"
              rows="20"
              selectionStart="1"
              selectionEnd="1000"
            >
(a : 0.1, (b : 0.11, (c : 0.12, d : 0.13) : 0.14) : 0.15)</textarea
            >
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="button1"
              id="validate_newick"
            >
              Display this tree
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <div class="modal" id="newick_export_modal" role="dialog">
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-body" id="newick_body">
            <textarea
              id="nwk_export_spec"
              autofocus="true"
              placeholder=""
              style="width: 100%; height: 100%"
              rows="20"
            ></textarea>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="button1"
              data-dismiss="modal"
            >
              Close
            </button>
          </div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <div class="modal" id="progress_model">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-hidden="true"
            >
              &times;
            </button>
            <h4 class="modal-title">Task in progress</h4>
          </div>
          <div class="modal-body" id="progress_model_body"></div>
        </div>
        <!-- /.modal-content -->
      </div>
      <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <div id="controls">
      <form id="controls_form" style="width:200px;"></form>
    </div>

    <div class="container" id="main_display" >
      <div class="row">
        <div class="col-md-8">
          <div class="button1" role="toolbar" id="toolbar">
            <div class="button1">
              <button
                type="button"
                class="button1"
                data-direction="vertical"
                data-amount="1"
                title="Expand vertical spacing"
              >
                <i class="fa fa-arrows-v"></i>
              </button>
              <button
                type="button"
                class="button1"
                data-direction="vertical"
                data-amount="-1"
                title="Compress vertical spacing"
              >
                <i class="fa  fa-compress fa-rotate-135"></i>
              </button>
              <button
                type="button"
                class="button1"
                data-direction="horizontal"
                data-amount="1"
                title="Expand horizonal spacing"
              >
                <i class="fa fa-arrows-h"></i>
              </button>
              <button
                type="button"
                class="button1"
                data-direction="horizontal"
                data-amount="-1"
                title="Compress horizonal spacing"
              >
                <i class="fa  fa-compress fa-rotate-45"></i>
              </button>
              <button
                type="button"
                class="button1"
                id="sort_ascending"
                title="Sort deepest clades to the bottom"
              >
                <i class="fa fa-sort-amount-asc"></i>
              </button>
              <button
                type="button"
                class="button1"
                id="sort_descending"
                title="Sort deepsest clades to the top"
              >
                <i class="fa fa-sort-amount-desc"></i>
              </button>
              <button
                type="button"
                class="button1"
                id="sort_original"
                title="Restore original order"
              >
                <i class="fa fa-sort"></i>
              </button>
              <button
                type="button"
                class="button1"
                id="save_image"
                title="Save image"
              >
                <i class="fa fa-picture-o"></i>
              </button>
            </div>
            <div class="button1" role="group">
              <button
                class="button1 active phylotree-layout-mode"
                data-mode="linear"
              >
                Linear
              </button>
              <button
                class="button1 phylotree-layout-mode"
                data-mode="radial"
              >
                Radial
              </button>
            </div>
            <div class="button1" role="group">
              <button
                class="button1 active phylotree-align-toggler"
                data-align="left"
              >
                <i class="fa fa-align-left"></i>
              </button>
              <button
                class="button1 phylotree-align-toggler"
                data-align="right"
              >
                <i class="fa fa-align-right"></i>
              </button>

            </div>
          </div>
        </div>
      </div>
    </div>

    <table align ="left">    
      <tbody>
      <tr>
        <th>
          <div id="tree_container1" class="tree-widget" style="display: block,width: 10%,padding:0px;"></div>
        </th>
        <th>
          <div id="tree_container2" class="tree-widget" style="display: block,width: 5%,padding:0px;"></div>
        </th>
      </tr>
    </tbody>
    </table>
    <!--
###############################################################################################################################
-->

    <script>
      if('function' === typeof importScripts) {
        importScripts('../js/underscore.js');
      }

      var phylotree_extensions = new Object();
      $("#newick_export_modal").on("show.bs.modal", function(e) {
        $('textarea[id$="nwk_export_spec"]').val(
          tree1.getNewick(function(node) {
            var tags = [];
            selection_set.forEach(function(d) {
              if (node[d]) {
                tags.push(d);
              }
            });
            if (tags.length) {
              return "{" + tags.join(",") + "}";
            }
            return "";
          })
        );
      });

      $("#newick_file").on("change", function(e) {
        var files = e.target.files; // FileList object

        if (files.length == 1) {
          var f = files[0];
          var reader = new FileReader();
          reader.onload = function(e) {
            var res = e.target.result;
            var warning_div = d3
              .select("#main_display")
              .insert("div", ":first-child");

            tree1 = new phylotree.phylotree(res);
            if (!tree1["json"]) {
              warning_div
                .attr("class", "alert alert-danger alert-dismissable")
                .html(
                  "<strong>Newick parser error for file " +
                    f.name +
                    ": </strong> In file " +
                    res["error"]
                );
            } else {
              tree1.render({
                container: "#tree_container1",
                "draw-size-bubbles": false,
                "left-right-spacing": "fixed-step",
                "node-styler": node_colorizer,
                "edge-styler": edge_colorizer
              });

              tree1.display.selectionLabel(current_selection_name);

              tree1.display.countHandler(count => {
                $("#selected_branch_counter").text(function(d) {
                  return count[current_selection_name];
                });
              });

              // Get selection set names from parsed newick
              if (tree1.parsed_tags.length) {
                selection_set = tree1.parsed_tags;
              }

              update_selection_names();

              $("#newick_modal").modal("hide");

              $(tree1.display.container).empty();
              $(tree1.display.container).html(tree1.display.show());
            }
          };

          $("#newick-dropdown").dropdown("toggle");
          reader.readAsText(f);
        }
      });

      $("#newick_file2").on("change", function(e) {
        var files = e.target.files; // FileList object

        if (files.length == 1) {
          var f = files[0];
          var reader = new FileReader();

          reader.onload = function(e) {
            var res = e.target.result;
            var warning_div = d3
              .select("#main_display")
              .insert("div", ":first-child");

            tree2 = new phylotree.phylotree(res);
            preprocess_BCN(tree1, tree2);
            preprocess_BCN(tree2, tree1);
            tree1.nodes.tree = 1;
            tree2.nodes.tree = 2;
          
            if (!tree2["json"]) {
              warning_div
                .attr("class", "alert alert-danger alert-dismissable")
                .html(
                  "<strong>Newick parser error for file " +
                    f.name +
                    ": </strong> In file " +
                    res["error"]
                );
            } else {
              tree2.render({
                container: "#tree_container2",
                "draw-size-bubbles": false,
                "left-right-spacing": "fixed-step",
                "node-styler": node_colorizer,
                "edge-styler": edge_colorizer
              });

              tree2.display.selectionLabel(current_selection_name);

              tree2.display.countHandler(count => {
                $("#selected_branch_counter").text(function(d) {
                  return count[current_selection_name];
                });
              });

              // Get selection set names from parsed newick
              if (tree2.parsed_tags.length) {
                selection_set = tree2.parsed_tags;
              }

              update_selection_names();

              $("#newick_modal").modal("hide");
              
              $(tree2.display.container).empty();
              $(tree2.display.container).html(tree2.display.show());
              tree1.render({
                container: "#tree_container1",
                "draw-size-bubbles": false,
                "left-right-spacing": "fixed-step",
                "node-styler": node_colorizer,
                "edge-styler": edge_colorizer
              });
              $(tree1.display.container).empty();
              $(tree1.display.container).html(tree1.display.show());
            }
          };

        $("#newick-dropdown").dropdown("toggle");
         reader.readAsText(f);
        }
      });

      $("#display_tree").on("click", function(e) {
        tree1.options({ branches: "straight" }, true);
        tree2.options({ branches: "straight" }, true);
      });

      $("[data-direction]").on("click", function(e) {
        var which_function =
          $(this).data("direction") == "vertical"
            ? tree1.display.spacing_x.bind(tree1.display)
            : tree1.display.spacing_y.bind(tree1.display)
        which_function(which_function() + +$(this).data("amount")).update();
      });

      $("[data-direction]").on("click", function(e) {
        var which_function =
          $(this).data("direction") == "vertical"
            ? tree2.display.spacing_x.bind(tree2.display)
            : tree2.display.spacing_y.bind(tree2.display)
        which_function(which_function() + +$(this).data("amount")).update();
      });

      $(".phylotree-layout-mode").on("click", function(e) {
        if (tree1.display.radial() != ($(this).data("mode") == "radial")) {
          $(".phylotree-layout-mode").toggleClass("active");
          tree1.display.radial(!tree1.display.radial()).update();
        }
        if (tree2.display.radial() != ($(this).data("mode") == "radial")) {
          $(".phylotree-layout-mode").toggleClass("active");
          tree2.display.radial(!tree2.display.radial()).update();
        }
      });

      $("#toggle_animation").on("click", function(e) {
        var current_mode = $(this).hasClass("active");
        $(this).toggleClass("active");
        tree1.options({ transitions: !current_mode })
        tree2.options({ transitions: !current_mode });
      });

      $(".phylotree-align-toggler").on("click", function(e) {
        var button_align = $(this).data("align");
        var tree1_align = tree1.display.options.alignTips;

        if (tree1_align != button_align) {
          tree1.display.alignTips(button_align == "right");
          $(".phylotree-align-toggler").toggleClass("active");
          tree1.display.update();
        }
        var tree2_align = tree2.display.options.alignTips;

        if (tree2_align != button_align) {
          tree2.display.alignTips(button_align == "right");
          $(".phylotree-align-toggler").toggleClass("active");
          tree2.display.update();
        }
      });


      function sort_nodes(asc, tree) {
        tree.resortChildren(function(a, b) {
          return (b.height - a.height || b.value - a.value) * (asc ? 1 : -1);
        });
      }

      $("#sort_original").on("click", function(e) {
        tree1.resortChildren(function(a, b) {
          return a["original_child_order"] - b["original_child_order"];
        });
        tree2.resortChildren(function(a, b) {
          return a["original_child_order"] - b["original_child_order"];
        });
        tree1.update();
        tree2.update();
      });

      $("#sort_ascending").on("click", function(e) {
        sort_nodes(false, tree1);
        tree1.display.update();
        sort_nodes(false,tree2);
        tree2.display.update();
      });

      $("#sort_descending").on("click", function(e) {
        sort_nodes(true, tree1);
        tree1.display.update();
        sort_nodes(true, tree2);
        tree2.display.update();
      });

      $("#and_label").on("click", function(e) {
        tree1.display.internalLabel(function(d) {
          return d.reduce(function(prev, curr) {
            return curr[current_selection_name] && prev;
          }, true);
        }, true);
        tree2.display.internalLabel(function(d) {
          return d.reduce(function(prev, curr) {
            return curr[current_selection_name] && prev;
          }, true);
        }, true);
      });

      $("#or_label").on("click", function(e) {
        tree1.display.internalLabel(function(d) {
          return d.reduce(function(prev, curr) {
            return curr[current_selection_name] || prev;
          }, false);
        }, true);
        tree2.display.internalLabel(function(d) {
          return d.reduce(function(prev, curr) {
            return curr[current_selection_name] || prev;
          }, false);
        }, true);
      });

      $("#filter_add").on("click", function(e) {
        tree1.display
          .modifySelection(function(d) {
            return d.tag || d[current_selection_name];
          })
          .modifySelection(
            function(d) {
              return false;
            },
            "tag",
            false,
            false
          );
          tree2.display
          .modifySelection(function(d) {
            return d.tag || d[current_selection_name];
          })
          .modifySelection(
            function(d) {
              return false;
            },
            "tag",
            false,
            false
          );
      });

      $("#filter_remove").on("click", function(e) {
        tree1.display.modifySelection(function(d) {
          return !d.tag;
        });
        tree2.display.modifySelection(function(d) {
          return !d.tag;
        });
      });

      $("#select_all").on("click", function(e) {
        tree1.display.modifySelection(function(d) {
          return true;
        });
        tree2.display.modifySelection(function(d) {
          return true;
        });
      });

      $("#select_all_internal").on("click", function(e) {
        tree1.display.modifySelection(function(d) {
          return !tree1.isLeafNode(d.target);
        });
        tree2.display.modifySelection(function(d) {
          return !tree2.isLeafNode(d.target);
        });
      });

      $("#select_all_leaves").on("click", function(e) {
        tree1.display.modifySelection(function(d) {
          return tree1.isLeafNode(d.target);
        });
        tree2.display.modifySelection(function(d) {
          return tree2.isLeafNode(d.target);
        });
      });

      $("#select_none").on("click", function(e) {
        tree1.display.modifySelection(function(d) {
          return false;
        });
        tree2.display.modifySelection(function(d) {
          return false;
        });
      });

      $("#clear_internal").on("click", function(e) {
        tree1.display.modifySelection(function(d) {
          return tree1.isLeafNode(d.target)
            ? d.target[current_selection_name]
            : false;
        });
        tree2.display.modifySelection(function(d) {
          return tree2.isLeafNode(d.target)
            ? d.target[current_selection_name]
            : false;
        });
      });

      $("#clear_leaves").on("click", function(e) {
        tree1.display.modifySelection(function(d) {
          return !tree1.isLeafNode(d.target)
            ? d.target[current_selection_name]
            : false;
        });
        tree2.display.modifySelection(function(d) {
          return !tree2.isLeafNode(d.target)
            ? d.target[current_selection_name]
            : false;
        });
      });

      $("#display_dengrogram").on("click", function(e) {
        tree1.display.options({ branches: "step" }, true);
        tree2.display.options({ branches: "step" }, true);
      });

      $("#branch_filter").on("input propertychange", function(e) {
        var filter_value = $(this).val();

        var rx = new RegExp(filter_value, "i");

        tree1.display.modifySelection(n => {
          if (!n.target.data.name) {
            return false;
          }
          m = n.target.data.name.search(rx);
          return filter_value.length && m != -1;
        }, "tag");

        tree2.display.modifySelection(n => {
          if (!n.target.data.name) {
            return false;
          }
          m = n.target.data.name.search(rx);
          return filter_value.length && m != -1;
        }, "tag");
      });

      node1 = [];
      node2 = [];

      function default_tree_settings() {
        tree1 = phylotree();
        tree1.branchLength(null);
        tree1.branchName(null);
        tree1.display.radial(false).separation(function(a, b) {
          return 0;
        });
      }

      function node_colorizer(element, data) {
        try {
          var count_class = 0;
          selection_set.forEach(function(d, i) {  
            if (data[d]) {
              count_class++;
              element.style(
                "fill",
                color_scheme(i),
                i == current_selection_id ? "important" : null
              );
            }
          });

          if (count_class > 1) {
          } else {
            if (count_class == 0) {
              element.style("fill", null);
            }
          }
        } catch (e) {}
      }

      function edge_colorizer(element, data) {

        try {
          var count_class = 0;

          selection_set.forEach(function(d, i) {
            if (data[d]) {
              count_class++;
              element.style(
                "stroke",
                color_scheme(i),
                i == current_selection_id ? "important" : null
              );
            }
          });

          if (count_class > 1) {
            element.classed("branch-multiple", true);
          } else if (count_class == 0) {
            element.style("stroke", null).classed("branch-multiple", false);
          }
        } catch (e) {}
      }

      var valid_id = new RegExp("^[\\w]+$");

      $("#selection_name_box").on("input propertychange", function(e) {
        var name = $(this).val();

        var accept_name =
          selection_set.indexOf(name) < 0 && valid_id.exec(name);

        d3.select("#save_selection_button").classed(
          "disabled",
          accept_name ? null : true
        );
      });


      $("#selection_delete").on("click", function(e) {
        tree1.display.updateKeyName(selection_set[current_selection_id], null);
        selection_set.splice(current_selection_id, 1);

        if (current_selection_id > 0) {
          current_selection_id--;
        }
        current_selection_name = selection_set[current_selection_id];
        update_selection_names(current_selection_id);
        $("#selection_name_box").val(current_selection_name);

        send_click_event_to_menu_objects(
          new CustomEvent(selection_menu_element_action, {
            detail: ["save", this]
          })
        );
        e.preventDefault();
      });

      $("#selection_new").on("click", function(e) {
        d3.select("#save_selection_button")
          .classed("disabled", true)
          .on("click", function(e) {
            // save selection handler
            current_selection_name = $("#selection_name_box").val();
            current_selection_id = selection_set.length;
            selection_set.push(current_selection_name);
            update_selection_names(current_selection_id);
            send_click_event_to_menu_objects(
              new CustomEvent(selection_menu_element_action, {
                detail: ["save", this]
              })
            );
          });

        d3.select("#cancel_selection_button")
          .classed("disabled", false)
          .on("click", function(e) {
            // save selection handler
            $("#selection_name_box").val(current_selection_name);
            send_click_event_to_menu_objects(
              new CustomEvent(selection_menu_element_action, {
                detail: ["cancel", this]
              })
            );
          });

        send_click_event_to_menu_objects(
          new CustomEvent(selection_menu_element_action, {
            detail: ["new", this]
          })
        );
        e.preventDefault();
      });

      function send_click_event_to_menu_objects(e) {
        $(
          "#selection_new, #selection_delete, #selection_rename, #save_selection_name, #selection_name_box, #selection_name_dropdown"
        )
          .get()
          .forEach(function(d) {
            d.dispatchEvent(e);
          });
      }

      function update_selection_names(id, skip_rebuild) {
        skip_rebuild = skip_rebuild || false;
        id = id || 0;

        current_selection_name = selection_set[id];
        current_selection_id = id;

        if (!skip_rebuild) {
          d3.selectAll(".selection_set").remove();

          d3.select("#selection_name_dropdown")
            .selectAll(".selection_set")
            .data(selection_set)
            .enter()
            .append("a")
            .attr("class", "selection_set dropdown-item")
            .attr("href", "#")
            .text(function(d) {
              return d;
            })
            .style("color", function(d, i) {
              return color_scheme(i);
            })
            .on("click", function(d, i) {
              update_selection_names(i, true);
            });
        }

        d3.select("#selection_name_box")
          .style("color", color_scheme(id))
          .property("value", current_selection_name);

        // Loop through all selection_sets
        _.each(selection_set, function(id) {
          tree1.display.selectionLabel(id);
          tree1.display.update();
        });

        tree1.display.selectionLabel(selection_set[id]);
        tree1.display.update();
      }

      var width = 800, //$(container_id).width(),
        height = 800, //$(container_id).height()
        selection_set = ["Foreground"],
        current_selection_name = $("#selection_name_box").val(),
        current_selection_id = 0,
        max_selections = 10;
      (color_scheme = d3.scaleOrdinal(d3.schemeCategory10)),
        (selection_menu_element_action = "phylotree_menu_element_action");

      var test_string =
        "(((EELA:0.150276,CONGERA:0.213019):0.230956,(EELB:0.263487,CONGERB:0.202633):0.246917):0.094785,((CAVEFISH:0.451027,(GOLDFISH:0.340495,ZEBRAFISH:0.390163):0.220565):0.067778,((((((NSAM:0.008113,NARG:0.014065):0.052991,SPUN:0.061003,(SMIC:0.027806,SDIA:0.015298,SXAN:0.046873):0.046977):0.009822,(NAUR:0.081298,(SSPI:0.023876,STIE:0.013652):0.058179):0.091775):0.073346,(MVIO:0.012271,MBER:0.039798):0.178835):0.147992,((BFNKILLIFISH:0.317455,(ONIL:0.029217,XCAU:0.084388):0.201166):0.055908,THORNYHEAD:0.252481):0.061905):0.157214,LAMPFISH:0.717196,((SCABBARDA:0.189684,SCABBARDB:0.362015):0.282263,((VIPERFISH:0.318217,BLACKDRAGON:0.109912):0.123642,LOOSEJAW:0.397100):0.287152):0.140663):0.206729):0.222485,(COELACANTH:0.558103,((CLAWEDFROG:0.441842,SALAMANDER:0.299607):0.135307,((CHAMELEON:0.771665,((PIGEON:0.150909,CHICKEN:0.172733):0.082163,ZEBRAFINCH:0.099172):0.272338):0.014055,((BOVINE:0.167569,DOLPHIN:0.157450):0.104783,ELEPHANT:0.166557):0.367205):0.050892):0.114731):0.295021)myroot";
      var container_id = "#tree_container1";


      var example_controls = d3.select("#controls_form").append("form");


      function selection_handler_name_box(e) {
        var name_box = d3.select(this);
        switch (e.detail[0]) {
          case "save":
          case "cancel":
            name_box
              .property("disabled", true)
              .style("color", color_scheme(current_selection_id));

            break;
          case "new":
            name_box
              .property("disabled", false)
              .property("value", "new_selection_name")
              .style("color", color_scheme(selection_set.length));
            break;
          case "rename":
            name_box.property("disabled", false);
            break;
        }
      }

      function selection_handler_new(e) {
        var element = d3.select(this);
        $(this).data("tooltip", false);
        switch (e.detail[0]) {
          case "save":
          case "cancel":
            if (selection_set.length == max_selections) {
              element.classed("disabled", true);
              $(this).tooltip({
                title: "Up to " + max_selections + " are allowed",
                placement: "left"
              });
            } else {
              element.classed("disabled", null);
            }
            break;
          default:
            element.classed("disabled", true);
            break;
        }
      }

      function selection_handler_rename(e) {
        var element = d3.select(this);
        element.classed(
          "disabled",
          e.detail[0] == "save" || e.detail[0] == "cancel" ? null : true
        );
      }

      function selection_handler_save_selection_name(e) {
        var element = d3.select(this);
        element.style(
          "display",
          e.detail[0] == "save" || e.detail[0] == "cancel" ? "none" : null
        );
      }

      function selection_handler_name_dropdown(e) {
        var element = d3.select(this).selectAll(".selection_set");
        element.classed(
          "disabled",
          e.detail[0] == "save" || e.detail[0] == "cancel" ? null : true
        );
      }

      function selection_handler_delete(e) {
        var element = d3.select(this);
        $(this).tooltip("dispose");
        switch (e.detail[0]) {
          case "save":
          case "cancel":
            if (selection_set.length == 1) {
              element.classed("disabled", true);
              $(this).tooltip({
                title:
                  "At least one named selection set <br> is required;<br>it can be empty, however",
                placement: "bottom",
                html: true
              });
            } else {
              element.classed("disabled", null);
            }
            break;
          default:
            element.classed("disabled", true);
            break;
        }
      }

      var datamonkey_save_image = function(type, container) {
        var prefix = {
          xmlns: "http://www.w3.org/2000/xmlns/",
          xlink: "http://www.w3.org/1999/xlink",
          svg: "http://www.w3.org/2000/svg"
        };

        function get_styles(doc) {
          function process_stylesheet(ss) {
            try {
              if (ss.cssRules) {
                for (var i = 0; i < ss.cssRules.length; i++) {
                  var rule = ss.cssRules[i];
                  if (rule.type === 3) {
                    // Import Rule
                    process_stylesheet(rule.styleSheet);
                  } else {
                    // hack for illustrator crashing on descendent selectors
                    if (rule.selectorText) {
                      if (rule.selectorText.indexOf(">") === -1) {
                        styles += "\n" + rule.cssText;
                      }
                    }
                  }
                }
              }
            } catch (e) {
              console.log("Could not process stylesheet : " + ss); // eslint-disable-line
            }
          }

          var styles = "",
            styleSheets = doc.styleSheets;

          if (styleSheets) {
            for (var i = 0; i < styleSheets.length; i++) {
              process_stylesheet(styleSheets[i]);
            }
          }

          return styles;
        }

        var svg = $(container).find("svg")[0];
        if (!svg) {
          svg = $(container)[0];
        }

        var styles = get_styles(window.document);

        svg.setAttribute("version", "1.1");

        var defsEl = document.createElement("defs");
        svg.insertBefore(defsEl, svg.firstChild);

        var styleEl = document.createElement("style");
        defsEl.appendChild(styleEl);
        styleEl.setAttribute("type", "text/css");

        // removing attributes so they aren't doubled up
        svg.removeAttribute("xmlns");
        svg.removeAttribute("xlink");

        // These are needed for the svg
        if (!svg.hasAttributeNS(prefix.xmlns, "xmlns")) {
          svg.setAttributeNS(prefix.xmlns, "xmlns", prefix.svg);
        }

        if (!svg.hasAttributeNS(prefix.xmlns, "xmlns:xlink")) {
          svg.setAttributeNS(prefix.xmlns, "xmlns:xlink", prefix.xlink);
        }

        var source = new XMLSerializer()
          .serializeToString(svg)
          .replace("</style>", "<![CDATA[" + styles + "]]></style>");
        var doctype =
          '<?xml version="1.0" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN" "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">';
        var to_download = [doctype + source];
        var image_string =
          "data:image/svg+xml;base66," + encodeURIComponent(to_download);

        if (navigator.msSaveBlob) {
          // IE10
          download(image_string, "image.svg", "image/svg+xml");
        } else if (type == "png") {
          b64toBlob(
            image_string,
            function(blob) {
              var url = window.URL.createObjectURL(blob);
              var pom = document.createElement("a");
              pom.setAttribute("download", "image.png");
              pom.setAttribute("href", url);
              $("body").append(pom);
              pom.click();
              pom.remove();
            },
            function(error) {
              console.log(error); // eslint-disable-line
            }
          );
        } else {
          var pom = document.createElement("a");
          pom.setAttribute("download", "image.svg");
          pom.setAttribute("href", image_string);
          $("body").append(pom);
          pom.click();
          pom.remove();
        }
      };

      $(document).ready(function() {
        tree1 = new phylotree.phylotree(test_string);

        tree1.render({
          container: "#tree_container1",
          "draw-size-bubbles": false,
          "left-right-spacing" : "fixed-step",
          "node-styler": node_colorizer,
          "edge-styler": edge_colorizer
        });


        tree1.display.countHandler(count => {
            $("#selected_branch_counter").text(function(d) {
              return count[current_selection_name];
            });
          });


        tree1.display.selectionLabel(current_selection_name);

        // Get selection set names from parsed newick
        if (tree1.parsed_tags.length) {
          selection_set = tree1.parsed_tags;
        }
        update_selection_names();

        $(tree1.display.container).empty();
        $(tree1.display.container).html(tree1.display.show());

        $("#save_image").on("click", function(e) {
          datamonkey_save_image("svg", "#tree_container1");
          datamonkey_save_image("svg", "#tree_container2");
        });
      });
    </script>

    <script>
      var _warn = console.warn;

      console.warn = function() {
        if (arguments[0].includes("Phylotree User Warning")) {
          var warning_div = d3
            .select("#main_display")
            .insert("div", ":first-child");
          warning_div
            .attr("class", "alert alert-danger alert-dismissable")
            .html(arguments[0]);
        }
        return _warn.apply(console, arguments);
      };
    </script>

  </body>
</html>
